pipeline {
    agent any


    environment {
        CI = 'true'
        NEXUS_URL = 'http://nexus:8081'
        NEXUS_USER = 'jenkins'
        NEXUS_PASS = 'jenkins123'
    }

    stages {
        stage('Configure Network') {
            steps {
                sh '''
                    echo "üîß Configurando rede para acesso ao GitHub..."
                    echo "üìã Projeto: Portal Minhas Aplica√ß√µes - Testes Automatizados"
                    echo "üéØ Foco: Testes de Consulta Cart√£o"
                    echo "üîó Reposit√≥rio: orivan-junior/testes-automatizados-portal-minhas-aplicacoes"
                    
                    # Limpar configura√ß√µes anteriores (ignorar erros se n√£o existirem)
                    unset HTTP_PROXY
                    unset HTTPS_PROXY
                    git config --global --unset http.proxy || true
                    git config --global --unset https.proxy || true
                    
                    echo "‚úÖ Configura√ß√£o de rede conclu√≠da"
                    echo "‚ö†Ô∏è Tentando checkout direto - se falhar, tentaremos SSH"
                '''
            }
        }

        stage('Checkout') {
            steps {
                script {
                    try {
                        echo "üîÑ Tentando checkout via HTTPS..."
                        git branch: 'main', 
                             url: 'https://github.com/orivan-junior/testes-automatizados-portal-minhas-aplicacoes.git',
                             credentialsId: 'github-credentials'
                        echo "‚úÖ Checkout HTTPS bem-sucedido!"
                    } catch (Exception e) {
                        echo "‚ùå Checkout HTTPS falhou: ${e.getMessage()}"
                        echo "üîÑ Tentando checkout via SSH..."
                        try {
                            git branch: 'main',
                                url: 'git@github.com:orivan-junior/testes-automatizados-portal-minhas-aplicacoes.git',
                                credentialsId: 'jenkins-ssh-key'
                            echo "‚úÖ Checkout SSH bem-sucedido!"
                        } catch (Exception sshError) {
                            echo "‚ùå Checkout SSH tamb√©m falhou: ${sshError.getMessage()}"
                            echo "üö® Ambos os m√©todos de checkout falharam!"
                            throw sshError
                        }
                    }
                }
            }
        }

        stage('Install Node.js (Skip if exists)') {
            steps {
                sh '''
                    if ! command -v node &> /dev/null; then
                        echo "Instalando Node.js 18..."
                        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
                        apt-get update && apt-get install -y nodejs
                    else
                        echo "Node.js j√° instalado: $(node --version)"
                    fi
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm ci'
            }
        }

        stage('Install Playwright Browsers (Chrome only)') {
            steps {
                sh '''
                    if [ ! -d "$HOME/.cache/ms-playwright" ]; then
                        echo "Instalando apenas Chrome..."
                        npx playwright install chromium --with-deps
                    else
                        echo "Browsers j√° instalados, pulando instala√ß√£o"
                    fi
                '''
            }
        }

        stage('Run Tests (Chrome only)') {
            steps {
                // Captura falhas nos testes para continuar o pipeline
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    sh '''
                        echo "Gerando testes BDD e executando Playwright para Portal Minhas Aplica√ß√µes"
                        echo "Executando testes de consulta cart√£o..."
                        
                        # Gera os testes a partir das features
                        npx bddgen || echo "bddgen falhou (continuando para captar relat√≥rios)"
                        
                        # Executa apenas os testes de consulta cart√£o
                        npm run consulta-cartao
                    '''
                }
            }
        }

        stage('Upload Evidence to Nexus') {
            steps {
                script {
                    def timestamp = new Date().format('yyyy-MM-dd_HH-mm-ss')
                    def buildNumber = env.BUILD_NUMBER
                    
                    sh '''
                        echo "üì§ Fazendo upload das evid√™ncias para o Nexus..."
                        echo "üìã Projeto: Portal Minhas Aplica√ß√µes - Testes Automatizados"
                        echo "üéØ Foco: Testes de Consulta Cart√£o"
                        
                        # Criar diret√≥rio tempor√°rio
                        mkdir -p /tmp/evidence-upload
                        
                        # Copiar evid√™ncias (com verifica√ß√£o de exist√™ncia)
                        [ -d "test-results/screenshots" ] && cp -r test-results/screenshots /tmp/evidence-upload/ || echo "Nenhuma screenshot encontrada"
                        [ -d "test-results/videos" ] && cp -r test-results/videos /tmp/evidence-upload/ || echo "Nenhum v√≠deo encontrado"
                        [ -d "allure-results" ] && cp -r allure-results /tmp/evidence-upload/ || echo "Nenhum resultado Allure encontrado"
                        [ -d "playwright-report" ] && cp -r playwright-report /tmp/evidence-upload/ || echo "Nenhum playwright-report encontrado"
                        
                        # Criar arquivo de informa√ß√µes do build
                        cat > /tmp/evidence-upload/build-info.txt << EOF
Build Number: ${BUILD_NUMBER}
Timestamp: ${timestamp}
Branch: ${GIT_BRANCH}
Commit: ${GIT_COMMIT}
Jenkins URL: ${BUILD_URL}
EOF
                        
                        # Fazer upload para Nexus
                        cd /tmp/evidence-upload
                        tar -czf evidence-${BUILD_NUMBER}-${timestamp}.tar.gz . 2>/dev/null
                        
                        # Upload usando curl com tratamento de erro
                        echo "üîÑ Tentando upload para Nexus..."
                        echo "üìÅ Arquivo: evidence-${BUILD_NUMBER}-${timestamp}.tar.gz"
                        echo "üåê URL: ${NEXUS_URL}/repository/playwright-evidence/"
                        
                        if curl -u ${NEXUS_USER}:${NEXUS_PASS} \
                             --upload-file evidence-${BUILD_NUMBER}-${timestamp}.tar.gz \
                             ${NEXUS_URL}/repository/playwright-evidence/evidence-${BUILD_NUMBER}-${timestamp}.tar.gz; then
                            echo "‚úÖ Upload conclu√≠do com sucesso"
                            echo "üîó URL: ${NEXUS_URL}/repository/playwright-evidence/evidence-${BUILD_NUMBER}-${timestamp}.tar.gz"
                        else
                            echo "‚ùå Upload falhou - continuando pipeline"
                            echo "‚ö†Ô∏è Verifique se o reposit√≥rio 'playwright-evidence' existe no Nexus"
                            echo "üìã Evid√™ncias salvas localmente em: /tmp/evidence-upload/"
                        fi
                    '''
                }
            }
        }

        stage('Upload Reports to Nexus') {
            steps {
                script {
                    def timestamp = new Date().format('yyyy-MM-dd_HH-mm-ss')
                    def buildNumber = env.BUILD_NUMBER
                    
                    sh '''
                        echo "üì§ Fazendo upload dos relat√≥rios para o Nexus..."
                        echo "üìã Projeto: Portal Minhas Aplica√ß√µes - Testes Automatizados"
                        echo "üéØ Foco: Testes de Consulta Cart√£o"
                        
                        # Criar diret√≥rio tempor√°rio para relat√≥rios
                        mkdir -p /tmp/reports-upload
                        
                        # Copiar relat√≥rios (com verifica√ß√£o de exist√™ncia)
                        [ -d "test-results" ] && cp -r test-results /tmp/reports-upload/ || echo "Nenhum resultado de teste encontrado"
                        [ -d "allure-results" ] && cp -r allure-results /tmp/reports-upload/ || echo "Nenhum resultado Allure encontrado"
                        [ -d "playwright-report" ] && cp -r playwright-report /tmp/reports-upload/ || echo "Nenhum playwright-report encontrado"
                        
                        # Criar arquivo de informa√ß√µes do build
                        cat > /tmp/reports-upload/build-info.txt << EOF
Build Number: ${BUILD_NUMBER}
Timestamp: ${timestamp}
Branch: ${GIT_BRANCH}
Commit: ${GIT_COMMIT}
Jenkins URL: ${BUILD_URL}
EOF
                        
                        # Fazer upload para Nexus
                        cd /tmp/reports-upload
                        tar -czf reports-${BUILD_NUMBER}-${timestamp}.tar.gz . 2>/dev/null
                        
                        # Upload usando curl com tratamento de erro
                        echo "üîÑ Tentando upload de relat√≥rios para Nexus..."
                        echo "üìÅ Arquivo: reports-${BUILD_NUMBER}-${timestamp}.tar.gz"
                        echo "üåê URL: ${NEXUS_URL}/repository/playwright-reports/"
                        
                        if curl -u ${NEXUS_USER}:${NEXUS_PASS} \
                             --upload-file reports-${BUILD_NUMBER}-${timestamp}.tar.gz \
                             ${NEXUS_URL}/repository/playwright-reports/reports-${BUILD_NUMBER}-${timestamp}.tar.gz; then
                            echo "‚úÖ Upload de relat√≥rios conclu√≠do com sucesso"
                            echo "üîó URL: ${NEXUS_URL}/repository/playwright-reports/reports-${BUILD_NUMBER}-${timestamp}.tar.gz"
                        else
                            echo "‚ùå Upload de relat√≥rios falhou - continuando pipeline"
                            echo "‚ö†Ô∏è Verifique se o reposit√≥rio 'playwright-reports' existe no Nexus"
                            echo "üìã Relat√≥rios salvos localmente em: /tmp/reports-upload/"
                        fi
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                // Gerar relat√≥rio Allure
                allure([
                    includeProperties: false,
                    jdk: '',
                    properties: [],
                    reportBuildPolicy: 'ALWAYS',
                    results: [[path: 'allure-results']]
                ])
                
                // Arquivos de evid√™ncia
                archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                archiveArtifacts artifacts: 'allure-results/**/*', allowEmptyArchive: true
                archiveArtifacts artifacts: 'playwright-report/**/*', allowEmptyArchive: true
                
                // Limpar arquivos tempor√°rios
                sh 'rm -rf /tmp/evidence-upload /tmp/reports-upload 2>/dev/null || true'
            }
        }
        
        failure {
            echo "‚ùå Pipeline falhou"
        }
        
        success {
            echo "‚úÖ Pipeline executado com sucesso"
        }
    }
}
